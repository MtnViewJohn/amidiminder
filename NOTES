NOTES


# TODO

## state and profiles

[x] file locations in code somewhere
    [x] handle "-" to mean stdin/stdout
    [x] safe file write code (write to .save, rename)

[ ] reorg
    [ ] change commtest command on the wire from "ahoy" to "commtest"
        [] find suitable haiku for the commtest command
    [x] hard and soft resets
        [x] user optinos on the reset command


[x] command line and deamon communication
    [x] save command
    [x] command logging reception in IPC
    [x] support command options

[] new observed connection/disconnection logic
    [] correctly adjusting observed rules if needed
    [] improve messages to the log on adding / removing observed rules
    [] checking for rule consistency
    [] expected disconnect optimization
    [] optimize saving observedRules

[] Primary port logic - and general refactor
    [] ? on reset just scan activeConnections

## general

[] tidy port names in observed rules
    - if client name is a prefix of the port, remove it and make partial match

[] man pages
    [] need more examples at the end of amidiminder-profile.5
    [] ? symlink all the user commands, like:
            amidiminder-load(1) -> amidiminder(1)

[] error handling
    [] switch to throwing errors on fatal system (and Seq) errors
    [] review all error messages
        [] leading case
        [] wording
    [] handle socket errors in the IPC code intellegently
        [] client wants to report and exit
        [] server wants to report and discard (aborting the command in progress)
        [x] calls to write in ipc.cpp should have the return value checked
    [] when user commands can't find the socket - tell user to start the daemon

## aconnect functionality

[] connect & disconnect
[] list

## other

[] improve output of check command
[] move verbose port details option to the list command
 [] fix CPP_FLAGS for debugging to -Og
[x] group subcommands in Args to make help more clear
[] print rules when loading profile?
[] ? case insensitive client and port name matches
[] ? get systemctl reload to call amidiminder reset
[] replace -p with just a verbosity check
    [] ? move -v and -q flags to daemon only... only place really used


## future

[] periodically check clients and ports for name and capability changes
    (since, due to kernel bugs, the change events are never sent), and if there
    are changes, remove and re-add the relevant ports
    N.B.: Not clear this is really needed, since we don't see any applications
    that really change port names or capabilities after being created. See the
    code in MidiMinder::handleSeqEvent for details about client name changes.
[] figure out how to fsync in Files::writeFile()

# MAJOR THEMES

## aconnect functionality
    - using the better syntax and naming for making, listing
    - and breaking connections
    - clear all connections

## connection state
    - keep what is intended even across reboot
    - create provisional rules when connections are made
    - (and delete them when broken)
    - save those in a live file (in /etc?)
    - on load use the user written set & the saved set

## connection setups
    - named setups - one is active
    - merge setups?
    - save current state as a setup
    - files in standard places

## maturty
    - man page
    - bash completion
    - SIGHUP for reload
    - handle daemon running or not


# DESIGN

Two rules files:
    Profile
        come from user
        symlink from /etc/amidiminder.rules to ???
        how to recognize chances in rules?
            - observe file change?
            - command to switch the symlink?
            - signal to reload?
    Observed
        from observations of connects and disconnects
        relative to the Profile rules
            a connect that the Profile rules would make won't be recorded
            has to be able to record overrides of the Profile rules

    Static & Dynamic?

Modes:
    daemon          - like the current operation
    connect         - make a connection, the minder will see it
    disconnect      - break a connection, the minder will see it
    reset           - clear the live rules, reset to only connections from Profile
    load            - set new Profile rules & reset
    save            - save the current Profile & Observed rules as new single rules file
    check           - check rule set file
    list            - show devices, ports, and connections


# DAW NOTES

PureData
    - When changing number of MIDI ports, deletes them all
      then re-adds them. This works for us.
    - OMG - it sets the name of the client AFTER it creates the ports

Renoise
    - Has separate clients for In and Out!
    - Has non-exported ports first, so user ports don't start from zero
    - Adds and removes ports, at times willy-nilly. If you connect a port
      to a device in the app, it deletes its port, recreates it named with
      the name of the other port, and then connects them.  This seems okay
      with midiminder
    - ? Perhaps we want a "ignore client" list - since Renoise does a fine
      job of managing MIDI ports on it's own.
    - Interestingly: no output ports other than sync!!

Reaper
    - Normally talks to raw MIDI devices
    - Has one "virtual" in and one "virtual" out port, each uses its own
      ALSA client (!), and the clients are named "Client-128" and "Client-129",
      the ports are named "Virtual RawMIDI" no matter what they are renamed in
      the UI.

LMMS
    - Lets users pick other ALSA ports as MIDI in/out for specific tracks
    - Will create a port and connect it for each such assignment
    - Doesn't seem to notice when connections are changed outside of it
    -

Ardour
    - Creates a ton of clients: A pair for each other ALSA port, each client
      has one port in or out. These are connected to each of the other
      ports. BUT, none of the Ardour ports are marked subs - so no idea how
      these connections are made.
    [] caused amidiminder to generate ALSA Seq error -2 in get client info
    [] need to make sure these ports are completely and correctly ignored

bitwig - only x86-64 available
